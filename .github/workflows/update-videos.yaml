name: Update Video List

on:
  push:
    paths:
      - "*.mp4"
  pull_request:
    paths:
      - "*.mp4"

jobs:
  update-videos:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install js-yaml
      run: npm install js-yaml

    - name: Update videos.yaml
      run: |
        node -e "
        const fs = require('fs');
        const yaml = require('js-yaml');
        const path = require('path');

        const videoDir = './';
        const yamlFile = 'videos.yaml';

        const videos = fs.readdirSync(videoDir)
          .filter(file => file.endsWith('.mp4'));

        let doc = {};
        try {
          doc = yaml.load(fs.readFileSync(yamlFile, 'utf8'));
        } catch (e) {
          console.log(e);
        }

        doc.videos = videos;

        fs.writeFileSync(yamlFile, yaml.dump(doc));
        "

    - name: Commit and push changes
      env:
        PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add videos.yaml
        git commit -m 'Update videos.yaml with new videos'
        git push https://x-access-token:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/${{ github.repository }}.git
        
